name: Sync Figma

concurrency:
  group: sync-figma
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      figma_foundations_file_key:
        description: 'Figma Foundations File Key (use default if empty)'
      figma_symbols_file_key:
        description: 'Figma Symbols File Key (use default if empty)'
      figma_icons_canvas:
        description: 'Figma Icons Canvas (use default if empty)'

permissions:
  contents: read

env:
  NX_NO_CLOUD: true

jobs:
  figma-export-design-tokens:
    name: Export Design Tokens from Figma
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Export Design Tokens from Figma
        run: npx nx run @ledgerhq/lumen-design-core:figma-export
        env:
          FIGMA_API_TOKEN: ${{ secrets.FIGMA_API_TOKEN }}
          FIGMA_FOUNDATIONS_FILE_KEY: ${{ github.event.inputs.figma_foundations_file_key || vars.FIGMA_FOUNDATIONS_FILE_KEY }}

      - name: Upload design tokens artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: design-tokens
          path: libs/design-core/tokens/

  figma-download-svgs:
    name: Download SVGs from Figma
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Download SVGs from Figma
        run: npx nx run @ledgerhq/lumen-design-core:figma-download-svgs
        env:
          FIGMA_API_TOKEN: ${{ secrets.FIGMA_API_TOKEN }}
          FIGMA_SYMBOLS_FILE_KEY: ${{ github.event.inputs.figma_symbols_file_key || vars.FIGMA_SYMBOLS_FILE_KEY }}
          FIGMA_ICONS_CANVAS: ${{ github.event.inputs.figma_icons_canvas || vars.FIGMA_ICONS_CANVAS }}

      - name: Upload SVG artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: svg-symbols
          path: libs/design-core/symbols/

  design-tokens-etl:
    name: Process Design Tokens
    needs: figma-export-design-tokens
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Download design tokens artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: design-tokens
          path: libs/design-core/tokens/

      - name: Run Design Tokens ETL
        run: npx nx run @ledgerhq/lumen-design-core:design-tokens-etl

      - name: Upload processed tokens artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: processed-design-tokens
          path: libs/design-core/src/themes/

  generate-symbols-react:
    name: Generate React Symbol Components
    needs: figma-download-svgs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Download SVG artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: svg-symbols
          path: libs/design-core/symbols/

      - name: Generate React Symbol Components
        run: |
          npx nx run @ledgerhq/lumen-design-core:generate-symbols-react
          npx nx run-many --targets=build-deps --all
          npx nx run-many --target=lint --fix

      - name: Upload React symbols artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: react-symbols
          path: libs/ui-react/src/lib/Symbols/

  generate-symbols-react-native:
    name: Generate React Native Symbol Components
    needs: figma-download-svgs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Download SVG artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: svg-symbols
          path: libs/design-core/symbols/

      - name: Generate React Native Symbol Components
        run: |
          npx nx run @ledgerhq/lumen-design-core:generate-symbols-react-native
          npx nx run-many --targets=build-deps --all
          npx nx run-many --target=lint --fix

      - name: Upload React Native symbols artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: react-native-symbols
          path: libs/ui-rnative/src/lib/Symbols/

  create-pull-request:
    name: Create Pull Request
    needs:
      [design-tokens-etl, generate-symbols-react, generate-symbols-react-native]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to commit changes to branch
      pull-requests: write # Required to create and update pull requests
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: true # required to create the pull request

      - name: Download design tokens artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: design-tokens
          path: libs/design-core/tokens/

      - name: Download processed design tokens artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: processed-design-tokens
          path: libs/design-core/src/themes/

      - name: Download SVG symbols artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: svg-symbols
          path: libs/design-core/symbols/

      - name: Download React symbols artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: react-symbols
          path: libs/ui-react/src/lib/Symbols/

      - name: Download React Native symbols artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: react-native-symbols
          path: libs/ui-rnative/src/lib/Symbols/

      - name: Add release plan
        run: |
          mkdir -p .nx/version-plans
          TIMESTAMP=$(node -e "console.log(Date.now())")
          cat << EOF > .nx/version-plans/version-plan-$TIMESTAMP.md
          ---
          '@ledgerhq/lumen-design-core': patch
          '@ledgerhq/lumen-ui-rnative': patch
          '@ledgerhq/lumen-ui-react': patch
          ---

          Sync Figma Design Tokens & Symbols
          EOF

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@22a9089034f40e5a961c8808d113e2c98fb63676 # v7.0.11
        with:
          commit-message: 'ðŸ’„ (figma): Sync Figma Design Tokens & Symbols'
          title: 'ðŸ’„ (figma): Sync Figma Design Tokens & Symbols'
          body: |
            Automatically sync design tokens and symbol components from Figma:

            - âœ… Export design tokens from Figma API Local Variables
            - âœ… Process design tokens through ETL pipeline
            - âœ… Download SVG symbols from Figma
            - âœ… Generate React symbol components
            - âœ… Generate React Native symbol components
          branch: sync-figma
